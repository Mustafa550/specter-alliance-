from flask import Flask, request, render_template_string, session, redirect, url_for, flash
import random
import re
import string
import smtplib
from email.mime.text import MIMEText
from datetime import datetime, timedelta

app = Flask(__name__)
app.secret_key = "dearsiber_secret_key_2025"  # GÃ¼venlik iÃ§in deÄŸiÅŸtir

# Gmail SMTP ayarlarÄ± (kendi bilgilerini gir)
GMAIL_USER = "your_gmail@gmail.com"  # Kendi Gmail adresin
GMAIL_PASSWORD = "your_app_password"  # Gmail App Password (2FA aÃ§Ä±ksa oluÅŸtur)

BOT_TOKEN = "8265349766:AAFa-OYqXW_9m_5uhoFd3Ljl739-FOgKyuY"  # Bot token (deÄŸiÅŸtirme)
ADMIN_ID = 7886522892
CHANNEL_LINK = "https://t.me/+IFx5aGB37Ws5NDFk"
DAILY_LIMITS = 150
CREATE_LIMITS = 100
BAN_THRESHOLD = 6
USER_LIMITS = {}
USERS_DB = {}

# Telegram bot
from telebot import TeleBot
bot = TeleBot(BOT_TOKEN)

# BIN'ler
BINS = {
    "Visa": ["4539", "4916"],
    "Mastercard": ["51", "55"],
    "Garanti": ["403799"],
    "Ziraat": ["404937"]
}

# Luhn algoritmasÄ±
def luhn_validate(card_num):
    digits = [int(d) for d in card_num]
    checksum = sum(digits[-1::-2]) + sum(sum(divmod(d * 2, 10)) for d in digits[-2::-2])
    return checksum % 10 == 0

# Kart oluÅŸturucu
def generate_card():
    bin_type = random.choice(list(BINS.keys()))
    bin_prefix = random.choice(BINS[bin_type])
    account_num = "".join(random.choices(string.digits, k=12))
    card_num = bin_prefix + account_num[:15-len(bin_prefix)]
    if not luhn_validate(card_num):
        card_num = card_num[:-1] + str(10 - int(card_num[-1]) % 10)
    month = str(random.randint(1, 12)).zfill(2)
    year = str(random.randint(25, 30))
    cvv = "".join(random.choices(string.digits, k=3))
    return f"{card_num}|{month}|{year}|{cvv}"

# Checker
def check_card(card_str):
    try:
        card_num, month, year, cvv = card_str.split("|")
        if not luhn_validate(card_num):
            return "Dead (Luhn failed)"
        if random.random() < 0.20:  # %20 Live
            return "Live"
        return "Dead"
    except:
        return "Invalid format"

# GerÃ§ek e-posta doÄŸrulama
def send_verification_code(email):
    code = "".join(random.choices(string.digits, k=6))
    msg = MIMEText(f"Your verification code is {code}")
    msg["Subject"] = "DEARSIBER CC Checker Verification"
    msg["From"] = GMAIL_USER
    msg["To"] = email
    try:
        server = smtplib.SMTP("smtp.gmail.com", 587)
        server.starttls()
        server.login(GMAIL_USER, GMAIL_PASSWORD)
        server.send_message(msg)
        server.quit()
        return code
    except Exception as e:
        flash(f"Email error: {e}")
        return None

# GiriÅŸ/KayÄ±t
@app.route('/', methods=['GET', 'POST'])
def login_register():
    if request.method == 'POST':
        action = request.form.get('action')
        if action == 'register':
            email = request.form.get('email')
            if re.match(r"[^@]+@[^@]+\.[^@]+", email) and not email.endswith((".ru", ".xyz", ".top")):
                code = send_verification_code(email)
                if code:
                    session['verification_email'] = email
                    session['code'] = code
                    return redirect(url_for('verify_code'))
                flash('Email sending failed!')
            flash('Invalid or fake email!')
        elif action == 'login':
            email = request.form.get('email')
            password = request.form.get('password')
            if email in USERS_DB and USERS_DB[email]['password'] == password:
                session['user'] = email
                session['ip'] = request.remote_addr
                if request.remote_addr not in USER_LIMITS:
                    USER_LIMITS[request.remote_addr] = {'checks': 0, 'creates': 0, 'accounts': 1}
                return redirect(url_for('dashboard'))
            flash('Invalid credentials!')
    return render_template_string('''
    <!DOCTYPE html>
    <html lang="tr">
    <head>
        <title>DEARSIBER CC Checker</title>
        <style>
            body { background: linear-gradient(45deg, #ff0000, #00ff00, #0000ff); animation: rainbow 5s infinite; font-family: Arial; }
            @keyframes rainbow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
            h1 { text-align: center; color: white; text-shadow: 2px 2px #000; }
            .footer { position: fixed; bottom: 0; width: 100%; text-align: center; color: white; }
            .footer a { color: white; }
            form { background: rgba(255,255,255,0.1); padding: 20px; margin: 20px; border-radius: 10px; }
            input, button { width: 100%; padding: 10px; margin: 5px 0; border: none; border-radius: 5px; }
            button { background: #ff0000; color: white; cursor: pointer; }
        </style>
    </head>
    <body>
        <h1>DEARSIBER CC Checker</h1>
        <form method="POST">
            <input type="email" name="email" placeholder="Email" required>
            <input type="password" name="password" placeholder="Password" required>
            <button type="submit" name="action" value="register">Register</button>
            <button type="submit" name="action" value="login">Login</button>
        </form>
        <div class="footer">
            <a href="{{ CHANNEL_LINK }}">@DearSiber | Join Channel</a>
        </div>
    </body>
    </html>
    ''')

@app.route('/verify_code', methods=['GET', 'POST'])
def verify_code():
    if request.method == 'POST':
        code = request.form.get('code')
        email = session.get('verification_email')
        if code == session.get('code'):
            password = "".join(random.choices(string.ascii_letters + string.digits, k=8))
            USERS_DB[email] = {'password': password, 'registered': datetime.now()}
            session['user'] = email
            session['ip'] = request.remote_addr
            if request.remote_addr not in USER_LIMITS:
                USER_LIMITS[request.remote_addr] = {'checks': 0, 'creates': 0, 'accounts': 1}
            bot.send_message(ADMIN_ID, f"ðŸ†• <b>Yeni KayÄ±t:</b>\nE-posta: {email}\nKatÄ±lmak istiyorum!\nÅžifre: {password}")
            flash('Registration successful! Check your email for password.')
            return redirect(url_for('dashboard'))
        flash('Invalid code!')
    return render_template_string('''
    <!DOCTYPE html>
    <html lang="tr">
    <head>
        <title>DEARSIBER CC Checker</title>
        <style>
            body { background: linear-gradient(45deg, #ff0000, #00ff00, #0000ff); animation: rainbow 5s infinite; font-family: Arial; }
            @keyframes rainbow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
            h1 { text-align: center; color: white; text-shadow: 2px 2px #000; }
            .footer { position: fixed; bottom: 0; width: 100%; text-align: center; color: white; }
            .footer a { color: white; }
            form { background: rgba(255,255,255,0.1); padding: 20px; margin: 20px; border-radius: 10px; }
            input, button { width: 100%; padding: 10px; margin: 5px 0; border: none; border-radius: 5px; }
            button { background: #ff0000; color: white; cursor: pointer; }
        </style>
    </head>
    <body>
        <h1>DEARSIBER CC Checker</h1>
        <form method="POST">
            <input type="text" name="code" placeholder="Verification Code" required>
            <button type="submit">Verify</button>
        </form>
        <div class="footer">
            <a href="{{ CHANNEL_LINK }}">@DearSiber | Join Channel</a>
        </div>
    </body>
    </html>
    ''')

@app.route('/dashboard', methods=['GET', 'POST'])
def dashboard():
    if 'user' not in session:
        return redirect(url_for('login_register'))
    ip = session['ip']
    user = session['user']
    limits = USER_LIMITS.get(ip, {'checks': 0, 'creates': 0, 'accounts': 1})
    if limits['accounts'] > BAN_THRESHOLD:
        flash('IP banned due to multiple accounts!')
        bot.send_message(ADMIN_ID, f"ðŸš« <b>IP Ban:</b>\nIP: {ip}\nUser: {user}")
        session.pop('user', None)
        return redirect(url_for('login_register'))

    if request.method == 'POST':
        action = request.form.get('action')
        if action == 'check':
            if limits['checks'] >= DAILY_LIMITS:
                flash('Daily check limit (150) reached!')
                return render_template_string(get_template('dashboard'), user=user, limits=limits)
            cards_input = request.form.get('cards') or request.files.get('file').read().decode('utf-8') if request.files.get('file') else ''
            results = []
            for card in cards_input.splitlines():
                if card.strip():
                    result = check_card(card.strip())
                    results.append(f"{card}: {result}")
                    limits['checks'] += 1
            flash('Results: ' + '<br>'.join(results))
        elif action == 'create':
            count = int(request.form.get('count', 1))
            if limits['creates'] + count > CREATE_LIMITS:
                flash('Daily create limit (100) reached!')
                return render_template_string(get_template('dashboard'), user=user, limits=limits)
            generated = [generate_card() for _ in range(min(count, 10))]
            limits['creates'] += len(generated)
            flash('Generated cards: ' + '<br>'.join(generated))

    limits['accounts'] = len([k for k, v in USERS_DB.items() if v.get('ip') == ip])
    return render_template_string(get_template('dashboard'), user=user, limits=limits)

def get_template(name):
    if name == 'dashboard':
        return '''
        <!DOCTYPE html>
        <html lang="tr">
        <head>
            <title>DEARSIBER CC Checker</title>
            <style>
                body { background: linear-gradient(45deg, #ff0000, #00ff00, #0000ff); animation: rainbow 5s infinite; font-family: Arial; }
                @keyframes rainbow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
                h1 { text-align: center; color: white; text-shadow: 2px 2px #000; }
                .footer { position: fixed; bottom: 0; width: 100%; text-align: center; color: white; }
                .footer a { color: white; }
                form { background: rgba(255,255,255,0.1); padding: 20px; margin: 20px; border-radius: 10px; }
                input, button, textarea { width: 100%; padding: 10px; margin: 5px 0; border: none; border-radius: 5px; }
                button { background: #ff0000; color: white; cursor: pointer; }
            </style>
        </head>
        <body>
            <h1>DEARSIBER CC Checker</h1>
            <p>Welcome, {{ user }}! Checks left: {{ limits.checks }}/{{ DAILY_LIMITS }} | Creates left: {{ limits.creates }}/{{ CREATE_LIMITS }}</p>
            <form method="POST" enctype="multipart/form-data">
                <textarea name="cards" placeholder="kart|ay|yÄ±l|cvv"></textarea>
                <input type="file" name="file" accept=".txt">
                <button type="submit" name="action" value="check">Check Cards</button>
            </form>
            <form method="POST">
                <input type="number" name="count" placeholder="Number of cards" min="1" max="10">
                <button type="submit" name="action" value="create">Generate Cards</button>
            </form>
            <div class="footer">
                <a href="{{ CHANNEL_LINK }}">@DearSiber | Join Channel</a>
            </div>
        </body>
        </html>
        '''
    return ''

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)